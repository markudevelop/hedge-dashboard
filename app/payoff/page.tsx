"use client";

import React, { useState, useEffect } from 'react';
import Plot from 'react-plotly.js';

const CSV_STRING = `Instrument,Volume,Open,ExtValue,Rho,Theta,Vega,Gamma,NDelta,Î”|Delta,Last,Size,IV Bid,Bid,Mark,Ask,IV Ask,Size
BTC-27SEP24-18000-P,-,126.7,,-0.02675,-0.46147,0.27534,-,,-0.00039,0.0001,-,-,-,-,0.0002,140.05,0.1
BTC-27SEP24-19000-P,-,202.3,,-0.03713,-0.61465,0.37294,-,,-0.00054,0.0001,-,-,-,0.0001,0.0005,147.78,16
BTC-27SEP24-20000-P,-,189.4,,-0.05946,-0.94556,0.57376,-,,-0.00087,0.0001,-,-,-,0.0001,0.0006,144.62,16
BTC-27SEP24-21000-P,-,118.4,,-0.08484,-1.29663,0.79356,-,,-0.00124,0.0002,30,115.3,0.0001,0.0001,0.0002,123.07,0.1
BTC-27SEP24-22000-P,-,140.7,,-0.10092,-1.48079,0.93129,-,,-0.00147,0.0002,77.8,110.49,0.0001,0.0002,0.0002,117.96,0.1
BTC-27SEP24-23000-P,0.2,217.9,,-0.103,-1.44936,0.95292,-,,-0.00151,0.0001,102.2,105.9,0.0001,0.0002,0.0003,117.89,10
BTC-27SEP24-24000-P,-,317.1,,-0.13204,-1.78537,1.19448,-,,-0.00194,0.0002,146.2,101.5,0.0001,0.0002,0.0003,113.04,0.1
BTC-27SEP24-25000-P,-,282.7,,-0.14888,-1.93216,1.33494,-,,-0.00219,0.0002,156.9,97.29,0.0001,0.0002,0.0003,108.38,0.1
BTC-27SEP24-26000-P,-,182.2,,-0.20307,-2.53464,1.76411,-,,-0.00298,0.0002,10,99.62,0.0002,0.0003,0.0004,107.25,0.1
BTC-27SEP24-27000-P,-,119.4,,-0.23448,-2.80912,2.0108,-,,-0.00345,0.0007,10,95.48,0.0002,0.0004,0.0004,102.82,0.1
BTC-27SEP24-28000-P,-,171.3,,-0.27818,-3.19983,2.34587,-,,-0.00409,0.0007,10,95.46,0.0003,0.0004,0.0006,103.38,14.1
BTC-27SEP24-29000-P,-,193.4,,-0.34418,-3.80275,2.83626,-,,-0.00506,0.0007,10,94.44,0.0004,0.0005,0.0007,101,10
BTC-27SEP24-30000-P,-,734.3,,-0.40751,-4.32087,3.29762,-,,-0.006,0.0006,10,92.85,0.0005,0.0006,0.0008,98.44,10
BTC-27SEP24-31000-P,-,175.7,,-0.46288,-4.70469,3.69691,-,,-0.00683,0.0006,10,90.9,0.0006,0.0007,0.0009,95.77,14.8
BTC-27SEP24-32000-P,-,131.7,,-0.53963,-5.25791,4.23581,-,,-0.00797,0.0015,10,88.72,0.0007,0.0008,0.001,93.01,14.7
BTC-27SEP24-33000-P,5.5,200.4,,-0.62413,-5.82581,4.81717,-,,-0.00922,0.0009,10,86.36,0.0008,0.0009,0.0012,91.31,30.6
BTC-27SEP24-34000-P,-,138.2,,-0.73303,-6.55382,5.54611,-,,-0.01084,0.0016,17,83.89,0.0009,0.0011,0.0013,88.36,28
BTC-27SEP24-35000-P,15.5,469.3,,-0.83434,-7.13446,6.21379,-,,-0.01236,0.0011,10,82.43,0.0011,0.0012,0.0014,85.38,26
BTC-27SEP24-36000-P,-,324.6,,-0.96337,-7.87608,7.04154,-,,-0.01428,0.0022,14,79.7,0.0012,0.0014,0.0016,83.23,26
BTC-27SEP24-37000-P,1,219.5,,-1.11065,-8.67399,7.96309,-,,-0.01648,0.0017,16,77.8,0.0014,0.0016,0.0018,80.91,26
BTC-27SEP24-38000-P,-,303.5,,-1.27546,-9.50558,8.96898,-,,-0.01894,0.002,10,76.43,0.0017,0.0018,0.002,78.48,26
BTC-27SEP24-39000-P,0.4,532,,-1.478,-10.50481,10.16818,-,,-0.02197,0.002,13,74.11,0.0019,0.0021,0.0023,76.54,26
BTC-27SEP24-40000-P,0.5,876.1,,-1.74562,-11.83055,11.69419,-,,-0.02594,0.0026,3.4,72.81,0.0023,0.0025,0.0026,74.41,10
BTC-27SEP24-41000-P,0.3,255.3,,-1.97393,-12.71525,12.97115,-,,-0.02938,0.003,16,70.7,0.0026,0.0028,0.003,72.59,36.8
BTC-27SEP24-42000-P,0.7,257.5,,-2.29656,-14.06325,14.70349,0.00001,,-0.03419,0.0032,26,68.88,0.003,0.0032,0.0034,70.55,10
BTC-27SEP24-43000-P,7.1,202,,-2.68391,-15.60885,16.7022,0.00001,,-0.03996,0.0038,26.8,67.23,0.0035,0.0038,0.0039,68.72,10
BTC-27SEP24-44000-P,12.1,386.8,,-3.11288,-17.16082,18.83149,0.00001,,-0.04636,0.0044,23.8,65.68,0.0041,0.0044,0.0045,66.99,10
BTC-27SEP24-45000-P,477,913.5,,-3.69311,-19.3093,21.56318,0.00001,,-0.05495,0.005,22.8,64.16,0.0048,0.0052,0.0055,66.17,69.2
BTC-27SEP24-46000-P,3.1,439.9,,-4.24359,-20.95056,24.05479,0.00001,,-0.06317,0.006,34,62.36,0.0055,0.006,0.0065,64.91,71.1
BTC-27SEP24-47000-P,3.7,279,,-4.9519,-23.08136,27.08818,0.00001,,-0.07368,0.0075,36.4,61.05,0.0065,0.007,0.0075,63.32,66.7
BTC-27SEP24-48000-P,114.2,1957.7,,-5.78099,-25.40157,30.43731,0.00001,,-0.08595,0.008,5,60.45,0.008,0.0083,0.0085,61.45,40.8
BTC-27SEP24-49000-P,40.8,444.8,,-6.76258,-27.97875,34.1498,0.00002,,-0.10043,0.0105,5,59.36,0.0095,0.0098,0.01,60.26,15.8
BTC-27SEP24-50000-P,108.2,1422.3,,-7.8864,-30.66437,38.10759,0.00002,,-0.11697,0.0115,42.6,57.89,0.011,0.0116,0.012,59.5,64.5
BTC-27SEP24-51000-P,58.6,411.7,,-9.1647,-33.42185,42.27051,0.00002,,-0.13572,0.014,41.7,56.84,0.013,0.0136,0.014,58.3,28.8
BTC-27SEP24-52000-P,37.7,813,,-10.65042,-36.39132,46.69283,0.00002,,-0.1574,0.016,41,56.06,0.0155,0.0162,0.0165,57.38,20.8
BTC-27SEP24-53000-P,75.6,701.9,,-12.33231,-39.42674,51.22002,0.00002,,-0.18181,0.019,40,55.44,0.0185,0.0192,0.0195,56.64,15.9
BTC-27SEP24-54000-P,40.9,818.4,,-14.19372,-42.36443,55.6997,0.00003,,-0.20869,0.0215,80.6,54.89,0.022,0.0226,0.023,55.99,37.5
BTC-27SEP24-55000-P,21.1,1475.1,,-16.25938,-45.249,60.0705,0.00003,,-0.23831,0.0275,67.9,54.36,0.026,0.0267,0.027,55.38,23.3
BTC-27SEP24-56000-P,306.3,996,,-18.52161,-48.00906,64.19455,0.00003,,-0.27048,0.0305,64.4,54.3,0.031,0.0314,0.032,55.25,41.2
BTC-27SEP24-57000-P,12.4,515.3,,-20.9434,-50.46356,67.90986,0.00003,,-0.30463,0.042,54.8,53.68,0.036,0.0367,0.037,54.59,12.3
BTC-27SEP24-58000-P,38.3,669.9,,-23.5157,-52.59971,71.11895,0.00003,,-0.34054,0.0425,47.4,53.88,0.0425,0.0427,0.043,54.31,11.8
BTC-27SEP24-59000-P,39.2,731.3,,-26.21887,-54.41612,73.72675,0.00004,,-0.3778,0.049,70.9,53.53,0.049,0.0495,0.05,54.36,33.3
BTC-27SEP24-60000-P,132.2,1502.2,,-29.00415,-55.74379,75.65365,0.00004,,-0.41574,0.0565,48.8,53.49,0.0565,0.057,0.0575,54.3,27.3
BTC-27SEP24-62000-P,26.2,888.6,,-34.72264,-56.95008,77.3705,0.00004,,-0.49199,0.0875,8.8,53.49,0.0735,0.0739,0.0745,54.28,10.7
BTC-27SEP24-63000-P,13,98.5,,-37.59725,-56.96409,77.17844,0.00004,,-0.52922,0.1,9,53.15,0.0825,0.0835,0.085,55.13,11.4
BTC-27SEP24-64000-P,15.3,130.1,,-40.44834,-56.44104,76.33906,0.00004,,-0.56555,0.1045,13,52.32,0.0915,0.0937,0.0955,55.54,31.5
BTC-27SEP24-65000-P,8,929.3,,-43.24798,-55.59827,74.92584,0.00004,,-0.60034,0.125,15,51.81,0.1015,0.1045,0.106,55.5,31.5
BTC-27SEP24-66000-P,12.5,171.7,,-45.98698,-54.3439,72.99971,0.00004,,-0.63368,0.1362,11,51.66,0.1125,0.1157,0.1175,55.87,23.5
BTC-27SEP24-67000-P,12.5,43.8,,-48.65023,-52.7903,70.65042,0.00003,,-0.66523,0.1368,8,51.91,0.1245,0.1276,0.13,56.69,24.4
BTC-27SEP24-68000-P,-,34,,-51.23223,-50.9421,67.94117,0.00003,,-0.69505,0.133,6,52.65,0.1375,0.1399,0.142,56.72,22.5
BTC-27SEP24-69000-P,-,4.7,,-53.7244,-48.89094,64.96326,0.00003,,-0.72294,0.1699,9,51.58,0.149,0.1526,0.155,57.28,23.5
BTC-27SEP24-70000-P,2.2,715.9,,-56.09325,-46.83779,61.86089,0.00003,,-0.74832,0.184,9,51.5,0.162,0.1658,0.168,57.5,23.5
BTC-27SEP24-72000-P,-,1.1,,-60.58716,-42.18326,55.22675,0.00003,,-0.7943,0.369,23.6,50.56,0.1885,0.1931,0.1955,58.5,23.5
BTC-27SEP24-75000-P,-,361.3,,-66.56712,-35.40636,45.51346,0.00002,,-0.84858,0.2255,23.5,49.95,0.2315,0.2363,0.239,60.47,23.5
BTC-27SEP24-80000-P,-,58.6,,-74.9352,-25.54133,31.71324,0.00001,,-0.90918,0.343,23.5,46.47,0.307,0.3121,0.316,65.85,24.4
BTC-27SEP24-85000-P,-,27.4,,-81.84313,-18.64629,22.15382,0.00001,,-0.94313,0.432,24.4,-,0.3855,0.3907,0.394,69.47,24.5
BTC-27SEP24-90000-P,-,22.4,,-87.96891,-13.79794,15.69046,0.00001,,-0.96299,0.4745,23.5,-,0.465,0.4707,0.4745,75.9,23.6
BTC-27SEP24-95000-P,-,1.3,,-93.63523,-10.53084,11.45655,-,,-0.97469,0.555,24.5,-,0.5465,0.5513,0.555,81.1,24.5
BTC-27SEP24-100000-P,-,10.8,,-99.0431,-8.32484,8.66781,-,,-0.9818,0.6355,23.5,-,0.626,0.6323,0.6365,88.18,23.6
BTC-27SEP24-105000-P,-,1.2,,-104.31431,-6.70576,6.70554,-,,-0.98651,0.7085,23.5,-,0.7065,0.7135,0.717,97.67,24.5
BTC-27SEP24-110000-P,-,3.8,,-109.51415,-5.36594,5.18725,-,,-0.98996,0.728,24.4,-,0.788,0.7948,0.7985,103.95,24.5
BTC-27SEP24-115000-P,-,23.1,,-114.62883,-4.62228,4.29605,-,,-0.99191,0.5935,23.5,-,0.869,0.8762,0.881,106.66,23.6
BTC-27SEP24-120000-P,-,1.5,,-119.71925,-3.98215,3.57552,-,,-0.99343,0.8995,23.5,-,0.95,0.9577,0.9625,112.08,23.6
BTC-27SEP24-125000-P,-,1.1,,-124.80499,-3.24658,2.84633,-,,-0.99492,0.8635,23.5,-,1.031,1.0391,1.0435,115.36,24.5
BTC-27SEP24-130000-P,-,0.6,,-129.86392,-2.78552,2.37706,-,,-0.99585,0.8875,24.4,-,1.1125,1.1206,1.125,128.72,24.5
BTC-27SEP24-140000-P,-,15.1,,-139.95654,-1.93619,1.58758,-,,-0.99735,1.3735,23.5,-,1.2745,1.2835,1.29,136.41,23.6
BTC-27SEP24-160000-P,-,1,,-159.98661,-2.0315,1.45843,-,,-0.99759,1.252,23.5,-,1.599,1.6097,1.617,155.98,23.6
BTC-27SEP24-180000-P,-,1.1,,-180.06451,-1.21157,0.82736,-,,-0.99871,1.845,23.6,-,1.924,1.9358,1.9445,174.9,23.6
BTC-27SEP24-200000-P,-,0.7,,-200.10593,-0.84499,0.54903,-,,-0.99917,2.4075,23.6,-,2.2485,2.262,2.272,191.95,23.6
BTC-27SEP24-240000-P,-,1,,-240.16003,-0.47353,0.28403,-,,-0.99959,2.7935,23.5,-,2.897,2.9143,2.927,221.81,23.6
`;

const UNDERLYING_PRICE = 61436.26;
const RISK_FREE_RATE = 0.05;
const TIME_TO_MATURITY = 36 / 365;

const BlackScholes = {
  normalCDF: (x) => {
    const t = 1 / (1 + 0.2316419 * Math.abs(x));
    const d = 0.3989423 * Math.exp(-x * x / 2);
    const p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
    return x > 0 ? 1 - p : p;
  },

  calculatePutPrice: (S, K, T, r, sigma) => {
    const d1 = (Math.log(S / K) + (r + sigma * sigma / 2) * T) / (sigma * Math.sqrt(T));
    const d2 = d1 - sigma * Math.sqrt(T);
    return K * Math.exp(-r * T) * BlackScholes.normalCDF(-d2) - S * BlackScholes.normalCDF(-d1);
  }
};

const parseCSV = (csv) => {
  const lines = csv.trim().split('\n');
  const headers = lines[0].split(',');
  return lines.slice(1).map(line => {
    const values = line.split(',');
    return headers.reduce((obj, header, index) => {
      obj[header.trim()] = values[index].trim();
      return obj;
    }, {});
  });
};

const OptionsPayoffAnalysis = ({ csvString }) => {
  const [data, setData] = useState([]);

  useEffect(() => {
    if (csvString) {
      const parsedData = parseCSV(csvString);
      const putOptions = parsedData.filter(row => 
        row.Instrument && 
        row.Instrument.endsWith('-P') && 
        row['IV Bid'] !== '-' && 
        row['IV Bid'] !== '' &&
        row['Mark'] !== '-' &&
        row['Mark'] !== ''
      );

      const options = putOptions.map(opt => ({
        strike: parseFloat(opt.Instrument.split('-')[2]),
        iv: parseFloat(opt['IV Bid']) / 100,
        marketPrice: parseFloat(opt['Mark']) * UNDERLYING_PRICE,
      }));

      const newData = [];
      for (let priceDropPercent = 0; priceDropPercent <= 60; priceDropPercent += 10) {
        const newPrice = UNDERLYING_PRICE * (1 - priceDropPercent / 100);
        
        for (let ivIncrease = 0; ivIncrease <= 30; ivIncrease += 10) {
          const filteredOptions = [];

          options.forEach(put => {
            const initialPrice = put.marketPrice;
            if (initialPrice <= 0) return;

            const newIV = put.iv * (1 + ivIncrease / 100);
            const newOptionPrice = BlackScholes.calculatePutPrice(newPrice, put.strike, TIME_TO_MATURITY, RISK_FREE_RATE, newIV);
            const payoff = (newOptionPrice - initialPrice) / initialPrice;

            filteredOptions.push({
              strike: put.strike,
              priceDrop: priceDropPercent,
              ivIncrease,
              payoff
            });
          });

          // Sort by payoff and take the top 10
          filteredOptions.sort((a, b) => b.payoff - a.payoff);
          newData.push(...filteredOptions.slice(0, 10));
        }
      }

      setData(newData);
    }
  }, [csvString]);

  const x = data.map(d => d.strike);
  const y = data.map(d => d.priceDrop);
  const z = data.map(d => d.ivIncrease);
  const color = data.map(d => d.payoff);
  const size = data.map(d => Math.max(5, d.payoff * 100)); // Size scaled by payoff percentage

  return (
    <div className="w-full h-[600px]">
      <h2 className="text-2xl font-bold mb-4">Put Options Payoff Analysis (3D)</h2>
      <Plot
        data={[
          {
            x,
            y,
            z,
            mode: 'markers',
            marker: {
              size,
              color,
              colorscale: 'Viridis',
              colorbar: { title: 'Payoff (%)' },
              sizemode: 'diameter',
            },
            type: 'scatter3d',
            hovertemplate: 
              'Strike: $%{x}<br>' +
              'Price Drop: %{y}%<br>' +
              'IV Increase: %{z}%<br>' +
              'Payoff: %{marker.color:.2f}%<br>' +
              '<extra></extra>'
          },
        ]}
        layout={{
          scene: {
            xaxis: { title: 'Strike Price ($)' },
            yaxis: { title: 'Price Drop (%)' },
            zaxis: { title: 'IV Increase (%)' },
          },
          margin: { l: 0, r: 0, b: 0, t: 0 },
          autosize: true,
        }}
        style={{ width: '100%', height: '100%' }}
        config={{ responsive: true }}
      />
    </div>
  );
};

export default OptionsPayoffAnalysis;